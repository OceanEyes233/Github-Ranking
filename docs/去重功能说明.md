# 去重功能说明

## 功能概述

为了避免重复保存已经存在的 GitHub 仓库，系统新增了**自动去重功能**。

## 工作原理

### 1. 获取更多数据
- 原来：获取热榜 Top 10
- 现在：获取热榜 Top 25

### 2. 智能过滤
在处理数据前，系统会：
1. 查询 Notion 数据库中所有已存在的仓库名称
2. 从新获取的 25 个仓库中过滤掉重复的
3. 从剩余的新仓库中选择前 10 个进行处理

### 3. 优雅降级
- **不足 10 个新仓库**：处理所有新仓库（可能少于 10 个）
- **全部重复**：跳过处理，提示"今日热榜的所有仓库都已存在"
- **未配置 Notion**：不进行去重检查，直接处理前 10 个

## 流程图

```
获取 25 个热榜仓库
        ↓
检查 Notion 数据库
        ↓
过滤掉已存在的仓库
        ↓
┌─────────────────────┐
│  剩余 >= 10 个？    │
└─────────────────────┘
    ↓YES        ↓NO
选前10个    处理所有剩余
    ↓            ↓
 处理 README → AI 分析 → 保存到 Notion
```

## 测试方法

### 方法 1: 使用测试命令
```bash
npm run test
```

测试脚本会：
1. 显示两种数据源的对比
2. 如果配置了 Notion，还会显示去重结果

### 方法 2: 实际运行
```bash
npm run dev
```

运行时会看到类似输出：
```
🔍 检查重复数据...
📦 数据库中已有 15 个仓库
✂️  过滤掉 3 个重复仓库
✨ 剩余 22 个新仓库

📝 选取前 10 个新仓库进行处理
```

## 代码改动

### 新增函数 (notionService.js)

#### `getExistingRepositories()`
- 功能：查询 Notion 数据库中所有已存在的仓库
- 返回：`Set<string>` 仓库名称集合
- 特点：支持分页查询（每次 100 条）

#### `filterNewRepositories(repositories)`
- 功能：过滤掉已存在的仓库
- 参数：新获取的仓库列表
- 返回：去重后的仓库列表

### 修改文件

1. **src/notionService.js** - 新增去重相关函数
2. **index.js** - 增加去重逻辑
3. **fetch-once.js** - 增加去重逻辑
4. **test.js** - 新增去重测试

## 使用示例

### 场景 1: 首次运行
```
✓ 成功获取 25 个热门仓库

🔍 检查重复数据...
📦 数据库中已有 0 个仓库
✨ 所有 25 个仓库都是新的

📝 选取前 10 个新仓库进行处理
```

### 场景 2: 有部分重复
```
✓ 成功获取 25 个热门仓库

🔍 检查重复数据...
📦 数据库中已有 50 个仓库
✂️  过滤掉 8 个重复仓库
✨ 剩余 17 个新仓库

📝 选取前 10 个新仓库进行处理
```

### 场景 3: 全部重复
```
✓ 成功获取 25 个热门仓库

🔍 检查重复数据...
📦 数据库中已有 100 个仓库
✂️  过滤掉 25 个重复仓库
✨ 剩余 0 个新仓库

✅ 今日热榜的所有仓库都已存在，无需处理新数据
```

## 注意事项

1. **去重依据**：使用仓库的完整名称（格式：`owner/repo`）作为唯一标识
2. **查询开销**：首次查询会遍历整个 Notion 数据库，大数据量时可能需要几秒钟
3. **容错机制**：如果查询 Notion 失败，会跳过去重检查继续执行
4. **配置要求**：需要正确配置 `NOTION_API_KEY` 和 `NOTION_DATABASE_ID`

## 性能优化

- 使用 `Set` 数据结构进行快速查找（O(1) 复杂度）
- 支持分页查询，避免一次性加载大量数据
- 缓存机制：在同一次执行中，只查询一次 Notion 数据库

## 未来改进方向

- [ ] 支持基于日期的智能去重（例如：同一天不重复，但跨天可以）
- [ ] 添加缓存层，减少 Notion API 调用
- [ ] 支持手动配置去重策略（严格/宽松）

